<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoWatcher | Management Console</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      /* Add this to your <style> section */
      .prose table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .prose th,
      .prose td {
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px;
        text-align: left;
      }
      .prose ul {
        list-style-type: disc;
        margin-left: 20px;
      }
      .tab-content {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .leaflet-marker-icon {
        filter: hue-rotate(140deg) brightness(0.8) saturate(2) !important;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sidebar-link.active {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border-right: 4px solid #4ade80;
      }
      #map {
        background: #0f172a;
      }
    </style>
  </head>

  <body class="bg-slate-950 text-slate-100 flex min-h-screen">
    <aside
      class="w-64 border-r border-white/10 bg-slate-900/50 flex flex-col fixed h-full"
    >
      <div class="p-8">
        <h1 class="text-2xl font-black text-green-400 tracking-tighter">
          EcoWatcher
        </h1>
        <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">
          Green Bharat v1.0
        </p>
      </div>
      <nav class="flex-1 px-4 space-y-2 mt-4">
        <button
          onclick="showTab('dashboard')"
          id="btn-dashboard"
          class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition"
        >
          üìä Dashboard
        </button>
        <button
          onclick="showTab('alerts')"
          id="btn-alerts"
          class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition"
        >
          üö® Alert Logs
        </button>
        <button
          onclick="showTab('manage')"
          id="btn-manage"
          class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition"
        >
          üìç Manage Zones
        </button>
        <button
          onclick="showTab('ai')"
          id="btn-ai"
          class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400"
        >
          <span>ü§ñ</span> Eco-AI Advisor
        </button>
      </nav>
      <div class="p-6 border-t border-white/10 text-center flex flex-col gap-2">
        <p class="text-[10px] text-slate-500">Presentation: Feb 16, 2026</p>

        <a
          href="/api/system/reset"
          onclick="
            localStorage.removeItem('ecoChatHistory');
            return confirm(
              'Factory Reset: This will wipe all alerts, chat history, and reset zones. Proceed?',
            );
          "
          class="text-[9px] text-slate-700 hover:text-red-500/50 transition-colors uppercase tracking-tighter"
        >
          ‚ö†Ô∏è Reset Engine
        </a>
      </div>
    </aside>

    <main class="flex-1 ml-64 p-8">
      <section id="tab-dashboard" class="tab-content">
        <header class="mb-6">
          <h2 class="text-2xl font-bold">Live Monitoring Console</h2>
        </header>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="glass-card p-4 rounded-xl">
            <p class="text-slate-400 text-[10px] uppercase">Total Zones</p>
            <h2 class="text-3xl font-bold">{{ total_zones }}</h2>
          </div>
          <div class="glass-card p-4 rounded-xl border-l-4 border-orange-500">
            <p class="text-slate-400 text-[10px] uppercase">
              Affected Locations
            </p>
            <h2 class="text-3xl font-bold text-orange-400">
              {{ breached_zones_count }}
            </h2>
          </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
          <div class="lg:col-span-4">
            <h3
              class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-3 px-1"
            >
              Priority Feed
            </h3>
            <div class="flex flex-col gap-3 h-[480px]">
              {% for item in dashboard_zones %}
              <div
                class="glass-card flex-1 p-3 rounded-xl border-l-2 border-slate-800 flex flex-col justify-center"
              >
                <div class="flex justify-between items-center mb-1">
                  <div class="flex items-center gap-2 overflow-hidden">
                    <span class="font-bold text-sm text-white truncate"
                      >{{ item.info.name }}</span
                    >
                    <span class="text-[9px] text-slate-500 whitespace-nowrap">
                      (Lat: {{ "%.2f"|format(item.info.lat) }}, Lon: {{
                      "%.2f"|format(item.info.lon) }})
                    </span>
                  </div>
                  <span
                    class="animate-pulse h-1.5 w-1.5 rounded-full bg-green-500"
                  ></span>
                </div>

                <div
                  class="mt-1 text-[10px] text-slate-400 border-t border-white/5 pt-2 flex gap-3 flex-wrap items-center"
                >
                  <span
                    >AQI:
                    <b
                      class="{% if item.metrics.aqi > 200 %}text-red-400{% elif item.metrics.aqi > 100 %}text-orange-400{% else %}text-green-400{% endif %}"
                    >
                      {{ item.metrics.aqi }}
                    </b></span
                  >
                  <span
                    >Temp:
                    <b class="text-white">{{ item.metrics.temp }}¬∞C</b></span
                  >
                  <span
                    >Wind:
                    <b class="text-white"
                      >{{ item.metrics.wind_speed }}
                      <small class="text-[8px] font-normal opacity-50"
                        >km/h</small
                      ></b
                    ></span
                  >
                  <span
                    >UV: <b class="text-white">{{ item.metrics.uv }}</b></span
                  >
                </div>
              </div>
              {% endfor %} {% if dashboard_zones|length < 5 %} {% for i in
              range(5 - dashboard_zones|length) %}
              <div
                class="flex-1 border border-dashed border-white/5 rounded-xl"
              ></div>
              {% endfor %} {% endif %}
            </div>
          </div>

          <div class="lg:col-span-8">
            <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-3">
              Geospatial Distribution
            </h3>
            <div class="glass-card p-2 rounded-2xl h-[480px] overflow-hidden">
              <div id="map" class="w-full h-full rounded-xl"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-alerts" class="tab-content hidden">
        <header class="mb-8">
          <h2 class="text-3xl font-bold text-orange-400">Incident Archive</h2>
          <p class="text-slate-400">
            Detailed logs of environmental threshold violations.
          </p>
        </header>

        <div class="glass-card rounded-2xl overflow-hidden">
          <table class="w-full text-left text-[11px]">
            <thead class="bg-white/10 text-slate-400 border-b border-white/10">
              <tr class="text-left uppercase text-[10px] tracking-widest">
                <th class="p-4">Timestamp</th>
                <th class="p-4">Zone</th>
                <th class="p-4">AQI</th>
                <th class="p-4">Temp</th>
                <th class="p-4">Wind</th>
                <th class="p-4">UV</th>
                <th class="p-4">Noise</th>
                <th class="p-4">Violation Reason</th>
                <th class="p-4 rounded-tr-xl">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
              {% for alert in alerts %}
              <tr class="hover:bg-white/5 transition-colors">
                <td class="p-4 text-slate-500 font-mono">
                  {{ alert.timestamp }}
                </td>
                <td class="p-4 font-bold text-green-400">
                  {{ alert.zone_name }}
                </td>
                <td class="p-4 font-mono">{{ alert.aqi }}</td>
                <td class="p-4 font-mono">{{ alert.temp }} ¬∞C</td>
                <td class="p-4 font-mono">{{ alert.wind }} km/h</td>
                <td class="p-4 font-mono">{{ alert.uv }}</td>
                <td class="p-4 font-mono">{{ alert.noise }} dB</td>
                <td class="p-4 text-right">
                  <span
                    class="bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1 rounded-full font-bold uppercase text-[9px]"
                  >
                    {{ alert.reason }}
                  </span>
                </td>
                <td class="p-4">
                  <button
                    onclick="selectAlertForAI('{{ alert.id }}', '{{ alert.zone_name }}')"
                    class="text-blue-400 hover:text-white text-[10px] font-bold uppercase p-2 border border-blue-400/20 rounded hover:bg-blue-400/10 transition-all"
                  >
                    Analyze ü§ñ
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section id="tab-manage" class="tab-content hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">Zone Management</h2>
          <button
            onclick="
              document.getElementById('zoneModal').classList.remove('hidden')
            "
            class="bg-green-600 px-6 py-2 rounded-xl font-bold"
          >
            + Register Zone
          </button>
        </div>
        <div class="glass-card rounded-2xl overflow-hidden">
          <table class="w-full text-left">
            <thead class="bg-white/5 text-slate-400 uppercase text-xs">
              <tr>
                <th class="p-4">Zone Name</th>
                <th class="p-4">Coordinates</th>
                <th class="p-4 text-right">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
              {% for zone in zones %}
              <tr>
                <td class="p-4 font-bold text-white">
                  {{ zone.name }}{% if zone.featured %}<span
                    class="ml-2 text-[9px] text-blue-400 font-normal"
                    >PINNED</span
                  >{% endif %}
                </td>
                <td class="p-4 text-slate-500 text-sm italic">
                  Lat: {{ zone.lat }} | Long: {{ zone.lon }}
                </td>
                <td class="p-4 text-right space-x-4">
                  <a
                    href="/pin_zone/{{ zone.id }}"
                    class="text-blue-400 text-xs font-bold uppercase"
                    >{% if zone.featured %}Unpin{% else %}Pin{% endif %}</a
                  >
                  <a
                    href="/delete_zone/{{ zone.id }}"
                    class="text-red-500 text-xs font-bold uppercase"
                    >Delete</a
                  >
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      <section id="tab-ai" class="tab-content hidden">
        <h2 class="text-3xl font-bold text-blue-400 mb-6">Eco-AI Advisor</h2>
        <div
          class="glass-card rounded-3xl p-6 h-[500px] flex flex-col border-blue-500/20"
        >
          <div
            class="flex justify-between items-center mb-4 border-b border-white/5 pb-2"
          >
            <p
              class="text-[10px] uppercase font-bold text-slate-500 tracking-widest"
            >
              Live Intelligence Feed
            </p>
            <button
              onclick="
                localStorage.removeItem('ecoChatHistory');
                location.reload();
              "
              class="text-[9px] uppercase font-bold text-slate-500 hover:text-red-400 transition-colors flex items-center gap-1"
            >
              <span>üóëÔ∏è</span> Clear History
            </button>
          </div>

          <div
            id="chat-box"
            class="flex-1 overflow-y-auto space-y-4 mb-4 p-2 text-sm"
          ></div>

          <div
            class="flex gap-2 bg-slate-950/50 p-2 rounded-2xl border border-white/5 focus-within:border-blue-500/50 transition-all"
          >
            <input
              type="text"
              id="ai-input"
              onkeypress="if (event.key === 'Enter') askAI();"
              placeholder="Ask about air quality or safety..."
              class="flex-1 bg-transparent px-4 py-2 outline-none text-white placeholder:text-slate-600"
            />

            <button
              onclick="askAI()"
              class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-bold transition-all active:scale-95 text-sm flex items-center gap-2"
            >
              Ask AI <span>‚ú®</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <div
      id="zoneModal"
      class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-4"
    >
      <div
        class="bg-slate-900 border border-white/10 p-8 rounded-3xl w-full max-w-md"
      >
        <h2 class="text-xl font-bold mb-4">New Monitoring Zone</h2>
        <form action="/add_zone" method="POST" class="space-y-3">
          <input
            type="text"
            name="name"
            placeholder="Zone Name"
            required
            class="w-full bg-slate-800 p-3 rounded-xl border border-white/10"
          />
          <div class="grid grid-cols-2 gap-3">
            <input
              type="number"
              step="any"
              name="lat"
              placeholder="Lat"
              required
              class="w-full bg-slate-800 p-3 rounded-xl border border-white/10"
            />
            <input
              type="number"
              step="any"
              name="lon"
              placeholder="Long"
              required
              class="w-full bg-slate-800 p-3 rounded-xl border border-white/10"
            />
          </div>
          <div class="flex gap-2 pt-4">
            <button
              type="button"
              onclick="
                document.getElementById('zoneModal').classList.add('hidden')
              "
              class="flex-1 py-2 text-slate-500"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 bg-green-600 rounded-xl font-bold"
            >
              Register
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="toast-container"
      class="fixed bottom-5 right-5 z-[200] flex flex-col gap-3"
    ></div>

    <script>
      let map;
      function initMap() {
          map = L.map('map').setView([20.5937, 78.9629], 5);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

          const zones = {{ zones | tojson }};

          zones.forEach(z => {
              // Create a cleaner, multi-line popup
              const popupContent = `
                  <div style="color: #1e293b; font-family: sans-serif;">
                      <b style="font-size: 14px;">${z.name}</b><br>
                      <span style="font-size: 10px; color: #64748b; font-weight: bold;">
                          LAT: ${parseFloat(z.lat).toFixed(2)} | LON: ${parseFloat(z.lon).toFixed(2)}
                      </span>
                  </div>
              `;

              L.marker([z.lat, z.lon])
                  .addTo(map)
                  .bindPopup(popupContent);
          });

          setTimeout(() => map.invalidateSize(), 400);
      }

      function showTab(tabName) {
          document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
          document.getElementById("tab-" + tabName).classList.remove("hidden");
          document.querySelectorAll(".sidebar-link").forEach(l => l.classList.remove("active"));
          document.getElementById("btn-" + tabName).classList.add("active");
          if(tabName === 'dashboard' && map) setTimeout(() => map.invalidateSize(), 200);
          localStorage.setItem("activeTab", tabName);
      }

      function showToast(zone, reason) {
          const container = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = `bg-red-600 text-white px-6 py-4 rounded-2xl shadow-xl border border-red-400 transition-all duration-500 opacity-0`;
          toast.innerHTML = `<p class="text-[10px] uppercase font-black opacity-60">Threshold Breach</p><p class="font-bold">${zone}</p><p class="text-xs">${reason}</p>`;
          container.appendChild(toast);
          setTimeout(() => toast.classList.remove("opacity-0"), 100);
          setTimeout(() => { toast.classList.add("opacity-0"); setTimeout(() => toast.remove(), 500); }, 4000);
      }


      async function updateDashboard() {
          try {
              const response = await fetch("/api/update");
              const data = await response.json();
              let activeAlerts = data.filter((z) => z.alert !== null);

              activeAlerts.forEach((item) => {
                  // REDUCE to 8000ms so it fits inside the 10000ms (10s) interval
                  const organicDelay = Math.pow(Math.random(), 2) * 8000;

                  setTimeout(() => {
                      showToast(item.zone, item.alert);
                  }, organicDelay);
              });

          } catch (err) {
              console.error("Sync Idle...");
          }
      }

      window.onload = () => {
          initMap();

          // Restore Tab state
          const active = localStorage.getItem("activeTab") || "dashboard";
          showTab(active);

          // RESTORE AI CHAT:
          const savedChat = localStorage.getItem("ecoChatHistory");
          if (savedChat) {
              document.getElementById("chat-box").innerHTML = savedChat;
          }

          setInterval(updateDashboard, 15000);
      };

      // added new feature to ask ai about the alert with reference of id
      let currentSelectedAlertId = null;

      function selectAlertForAI(id, zoneName) {
          currentSelectedAlertId = id;
          // Switch to AI tab automatically
          showTab('ai');
          // Pre-fill the input to make it easy for the user
          document.getElementById("ai-input").value = `Tell me more about the incident in ${zoneName} (ID: ${id})`;

          // Optional: Show a small label in the chat UI so the user knows an alert is selected
          showToast("System", `ID ${id} attached to AI context.`);
      }

      async function askAI() {
          const input = document.getElementById("ai-input");
          const chatBox = document.getElementById("chat-box");
          const query = input.value;
          if(!query) return;

          // 1. Add User Message
          const userHTML = `<div class="bg-white/5 p-4 rounded-2xl ml-12 text-right border border-white/10 text-slate-300">${query}</div>`;
          chatBox.innerHTML += userHTML;
          input.value = "";
          chatBox.scrollTop = chatBox.scrollHeight;

          // 2. Show Loading
          const loadingId = "loading-" + Date.now();
          chatBox.innerHTML += `<div id="${loadingId}" class="bg-blue-500/10 p-4 rounded-2xl mr-12 animate-pulse text-blue-300">Consulting sensor network...</div>`;

          try {
              const response = await fetch("/api/chat", {
                  method: "POST",
                  headers: {"Content-Type": "application/json"},
                  body: JSON.stringify({
                      query: query,
                      selected_alert_id: currentSelectedAlertId // PASS THE ID HERE
                  })
              });
              const data = await response.json();

              document.getElementById(loadingId).remove();
              const formattedResponse = marked.parse(data.response);
              const aiHTML = `<div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-2xl mr-12 text-blue-50 prose prose-invert max-w-none">
                  ${formattedResponse}
              </div>`;
              chatBox.innerHTML += aiHTML;

              // 3. Add AI Response

              // 4. PERSISTENCE: Save the chat to localStorage
              localStorage.setItem("ecoChatHistory", chatBox.innerHTML);

          } catch (err) {
              document.getElementById(loadingId).innerText = "Connection Error.";
          }
          chatBox.scrollTop = chatBox.scrollHeight;
      }
    </script>
  </body>
</html>
